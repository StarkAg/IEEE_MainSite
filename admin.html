<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <title>Admin Dashboard | IEEE CS</title>
  <meta name="description" content="Admin dashboard for IEEE CS button click analytics">

  <link rel="shortcut icon" href="./assets/images/logo1.png" type="image/svg+xml">
  <link rel="stylesheet" href="./assets/css/style.css">
  <link rel="stylesheet" href="./assets/font/font.css">
</head>

<body id="top">

  <header class="header" data-header>
    <div class="container">
      <a href="/" class="logo">
        <img src="./assets/images/IEEE-CS_LogoTM-white.png" width="170" height="40" alt="IEEE">
      </a>

      <h1 class="h4" style="margin-left:auto;">Admin Dashboard</h1>
    </div>
  </header>

  <main style="padding-top: 120px;">
    <section class="section" aria-label="Admin analytics">
      <div class="container">
        <h2 class="h2 section-title" style="margin-bottom: 10px;">Button Clicks - Last 24 Hours</h2>
        <p class="section-text" style="margin-bottom: 20px;">
          This chart shows button and team tile clicks for the last 24 hours, with a separate colored line for each button.
        </p>

        <button id="refresh-clicks" class="hackathon-btn-primary" style="margin-bottom: 25px;">
          Refresh Data
        </button>

        <canvas id="clickChart" style="max-width: 100%;"></canvas>

        <p id="admin-status" class="section-text" style="margin-top: 15px; font-size: 1.4rem;"></p>
      </div>
    </section>
  </main>

  <!-- Supabase + Chart.js -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // Must match values in assets/js/script.js
    const SUPABASE_URL = 'https://phlggcheaajkupppozho.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBobGdnY2hlYWFqa3VwcHBvemhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyODQ0NTgsImV4cCI6MjA3ODg2MDQ1OH0.TGEDpm2uqKceOxAMB5aG6fd8uHESmwfdKF-cqm2QU84';

    const statusEl = document.getElementById('admin-status');
    const refreshBtn = document.getElementById('refresh-clicks');
    let chart;

    if (!window.supabase) {
      statusEl.textContent = 'Supabase client library failed to load.';
    }

    const supabaseClient = window.supabase
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    async function loadClickData() {
      if (!supabaseClient) {
        statusEl.textContent = 'Supabase client not initialized.';
        return;
      }

      statusEl.textContent = 'Loading...';
      refreshBtn.disabled = true;

      try {
        // Fetch last 24 hours of events
        const since = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
        const { data, error } = await supabaseClient
          .from('button_clicks')
          .select('button_id, created_at')
          .gte('created_at', since)
          .order('created_at', { ascending: true })
          .limit(5000);

        if (error) {
          console.error(error);
          statusEl.textContent = 'Error loading data from Supabase.';
          refreshBtn.disabled = false;
          return;
        }

        if (!data || data.length === 0) {
          statusEl.textContent = 'No click data for the last 24 hours. Try again after some interactions.';
          refreshBtn.disabled = false;
          if (chart) {
            chart.data.labels = [];
            chart.data.datasets = [];
            chart.update();
          }
          return;
        }

        // Build 24 hourly buckets ending at "now"
        const now = new Date();
        const labels = [];
        const bucketStartTimes = [];
        for (let i = 23; i >= 0; i--) {
          const bucketTime = new Date(now.getTime() - i * 60 * 60 * 1000);
          bucketStartTimes.push(bucketTime);
          labels.push(
            bucketTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
          );
        }

        // Aggregate per button_id per hour bucket
        const countsByButton = {};
        data.forEach(row => {
          const eventTime = new Date(row.created_at);
          const diffHours = Math.floor((now.getTime() - eventTime.getTime()) / (60 * 60 * 1000));
          if (diffHours < 0 || diffHours > 23) return; // outside 24h window

          const bucketIndex = 23 - diffHours; // 0 => oldest, 23 => current
          const id = row.button_id || 'unknown';
          if (!countsByButton[id]) {
            countsByButton[id] = new Array(24).fill(0);
          }
          countsByButton[id][bucketIndex] += 1;
        });

        const buttonIds = Object.keys(countsByButton);

        if (buttonIds.length === 0) {
          statusEl.textContent = 'No click data for the last 24 hours. Try again after some interactions.';
          refreshBtn.disabled = false;
          if (chart) {
            chart.data.labels = [];
            chart.data.datasets = [];
            chart.update();
          }
          return;
        }

        // Generate colored datasets per button
        const baseColors = [
          '#ff457a', '#4bc0c0', '#9966ff', '#ff9f40',
          '#36a2eb', '#ffcd56', '#2ecc71', '#e74c3c'
        ];

        const datasets = buttonIds.map((id, index) => {
          const color = baseColors[index % baseColors.length];
          return {
            label: id,
            data: countsByButton[id],
            borderColor: color,
            backgroundColor: color + '33',
            tension: 0.25
          };
        });

        const ctx = document.getElementById('clickChart').getContext('2d');
        if (!chart) {
          chart = new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets
            },
            options: {
              responsive: true,
              scales: {
                x: {
                  title: { display: true, text: 'Time (last 24 hours, hourly)' }
                },
                y: {
                  beginAtZero: true,
                  title: { display: true, text: 'Clicks' },
                  ticks: { precision: 0 }
                }
              }
            }
          });
        } else {
          chart.data.labels = labels;
          chart.data.datasets = datasets;
          chart.update();
        }

        statusEl.textContent = `Loaded ${data.length} events across ${buttonIds.length} button(s) in the last 24 hours.`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Unexpected error loading data.';
      } finally {
        refreshBtn.disabled = false;
      }
    }

    refreshBtn.addEventListener('click', loadClickData);
    // initial load
    loadClickData();
  </script>

</body>

</html>


